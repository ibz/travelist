{% extends "base.html" %}

{% block content %}

<script src="http://maps.google.com/maps?file=api&amp;v=2&amp;key={{ settings.GOOGLE_MAPS_API_KEY }}" type="text/javascript"></script>
<script src="{{ MEDIA_URL }}javascript/lib/markermanager.js" type="text/javascript"></script>

<script type="text/javascript">
function toggle_annotations(id)
{
    var ul = document.getElementById(id);
    ul.style.display = ul.style.display == 'none' ? 'block' : 'none';
    var a = document.getElementById("link_" + id);
    a.textContent = ul.style.display == 'none' ? "+" : "-";
}
</script>

<table width="100%">
<tr>
<td width="400px">

<div class="trip-details">
<h2>{{ trip.name }}</h2>
<ul class="plain-list">
    <li>Started on: {{ trip.start_date|date }}</li>
    <li>Ended on: {{ trip.end_date|date }}</li>
    <li>Owned by: {% ifequal user.id trip.user_id %}me{% else %}{{ trip.user.username }}{% endifequal %}</li>
</ul>

Trip segments:
<ul class="plain-list">
{% for segment in segments %}
    <li>
        <a id="link_segment_{{ forloop.counter }}" title="Toggle details"
           href="javascript:toggle_annotations('segment_{{ forloop.counter }}')">+</a>
        {{ segment.p1.name }} - {{ segment.p2.name }}
        {% ifequal user.id trip.user_id %}
            <a href="/trip/{{ trip.id }}/segment/{{ segment.id }}/edit/" title="Edit segment details">E</a>
            <a href="/trip/{{ trip.id }}/segment/{{ segment.id }}/annotation/new/" title="Add an annotation">A</a>
        {% endifequal %}
        <ul id="segment_{{ forloop.counter }}" class="plain-list" style="display: none;">
            {% if segment.start_date %}<li>Start date: {{ segment.start_date|date }}</li>{% endif %}
            {% if segment.end_date %}<li>End date: {{ segment.end_date|date }}</li>{% endif %}
            {% if segment.transportation_method %}<li>Transportation method: {{ segment.transportation_method_str }}</li>{% endif %}
            <li>Length: {{ segment.length|floatformat:2 }} km</li>
            {% for annotation in segment.annotation_set.all %}
                <li>{{ annotation.render_short }}</li>
            {% endfor %}
        </ul>
    </li>
{% endfor %}
</ul>

Trip points:
<ul class="plain-list">
{% for point in points %}
    <li>
        {% if point.annotation_count %}
            <a id="link_point_{{ forloop.counter }}" title="Toggle details"
               href="javascript:toggle_annotations(point_{{ forloop.counter }}')">+</a>
        {% endif %}
        {{ point.name }}
        {% ifequal user.id trip.user_id %}
            <a href="/trip/{{ trip.id }}/point/{{ point.id }}/annotation/new/" title="Add an annotation">A</a>
        {% endifequal %}
        <ul id="point_{{ forloop.counter }}" class="plain-list" style="display: none;">
            {% for annotation in point.annotation_set.all %}
                <li>{{ annotation.render_short }}</li>
            {% endfor %}
        </ul>
    </li>
{% endfor %}
</ul>
</div>
</td>

<td valign="top">
  <div id="map" style="width: 700px; height: 400px"></div>
  <script type="text/javascript">
      var point_data = [
      {% for point in trip.point_set.all %}
          [{{ point.coords.coords.0 }}, {{ point.coords.coords.1 }}, "{{ point.name }}"]
          {% if not forloop.last %},{% endif %}
      {% endfor %}
      ];
      $(document).ready(function() { initTripMap('map', point_data); });
      $(document).unload(function() { cleanupMap(); });
  </script>
</td>

</tr>
</table>

{% ifequal user.id trip.user_id %}
<a class="navigation" href="/trip/{{ trip.id }}/edit/">Edit trip</a>
{% endifequal %}

{% endblock %}
